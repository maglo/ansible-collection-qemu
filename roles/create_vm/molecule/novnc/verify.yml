---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    # ── noVNC template unit ──────────────────────────────────
    - name: Stat noVNC template service unit
      ansible.builtin.stat:
        path: /etc/systemd/system/novnc@.service
      register: novnc_template_unit

    - name: Assert noVNC template service unit file
      ansible.builtin.assert:
        that:
          - novnc_template_unit.stat.exists
          - novnc_template_unit.stat.pw_name == 'root'
          - novnc_template_unit.stat.gr_name == 'root'
          - novnc_template_unit.stat.mode == '0644'

    - name: Read noVNC template service unit content
      ansible.builtin.slurp:
        src: /etc/systemd/system/novnc@.service
      register: novnc_template_content

    - name: Assert noVNC template unit content
      vars:
        content: "{{ novnc_template_content.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'Ansible managed' in content"
          - "'/usr/bin/novnc_proxy' in content"
          - "'--listen ${NOVNC_PORT}' in content"
          - "'--vnc ${VNC_TARGET}' in content"
          - "'EnvironmentFile=/etc/qemu/vms/novnc-%i.conf' in content"

    # ── Per-VM environment files ─────────────────────────────
    - name: Stat per-VM noVNC environment files
      ansible.builtin.stat:
        path: "/etc/qemu/vms/novnc-{{ item }}.conf"
      register: novnc_env_files
      loop:
        - web01
        - db01
      loop_control:
        label: "{{ item }}"

    - name: Assert per-VM noVNC environment files exist
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.pw_name == 'root'
          - item.stat.gr_name == 'root'
          - item.stat.mode == '0644'
      loop: "{{ novnc_env_files.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Read web01 noVNC environment file
      ansible.builtin.slurp:
        src: /etc/qemu/vms/novnc-web01.conf
      register: web01_env_content

    - name: Assert web01 noVNC environment file content
      vars:
        content: "{{ web01_env_content.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'NOVNC_PORT=6080' in content"
          - "'VNC_TARGET=localhost:5900' in content"

    - name: Read db01 noVNC environment file
      ansible.builtin.slurp:
        src: /etc/qemu/vms/novnc-db01.conf
      register: db01_env_content

    - name: Assert db01 noVNC environment file content (auto-assigned port)
      vars:
        content: "{{ db01_env_content.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'NOVNC_PORT=6081' in content"
          - "'VNC_TARGET=localhost:5901' in content"

    # ── app01 should NOT have noVNC ─────────────────────────
    - name: Stat app01 noVNC environment file (should not exist)
      ansible.builtin.stat:
        path: /etc/qemu/vms/novnc-app01.conf
      register: app01_env_file

    - name: Assert app01 does not have noVNC environment file
      ansible.builtin.assert:
        that:
          - not app01_env_file.stat.exists

    # ── Per-VM noVNC service state ───────────────────────────
    - name: Check per-VM noVNC services are enabled
      ansible.builtin.systemd_service:
        name: "novnc@{{ item }}"
        enabled: true
      check_mode: true
      register: novnc_enabled_check
      failed_when: novnc_enabled_check.changed
      loop:
        - web01
        - db01

    - name: Check per-VM noVNC services are active
      ansible.builtin.command:
        cmd: "systemctl is-active novnc@{{ item }}"
      register: novnc_active_check
      changed_when: false
      failed_when: novnc_active_check.stdout != 'active'
      loop:
        - web01
        - db01

    # ── app01 noVNC service should not exist ─────────────────
    - name: Check app01 noVNC service does not exist
      ansible.builtin.command:
        cmd: "systemctl status novnc@app01"
      register: app01_novnc_status
      changed_when: false
      failed_when: app01_novnc_status.rc == 0
      ignore_errors: true

    # ── Per-VM ports are listening ───────────────────────────
    - name: Wait for per-VM noVNC ports
      ansible.builtin.wait_for:
        port: "{{ item }}"
        timeout: 10
      loop:
        - 6080  # web01 (explicit)
        - 6081  # db01 (auto-assigned)

    # ── Service dependencies ─────────────────────────────────
    - name: Read noVNC template to verify dependencies
      ansible.builtin.slurp:
        src: /etc/systemd/system/novnc@.service
      register: novnc_unit_content

    - name: Assert noVNC depends on qemu-vm service
      vars:
        content: "{{ novnc_unit_content.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'After=network.target qemu-vm@%i.service' in content"
        fail_msg: "noVNC service should depend on qemu-vm@%i.service"
