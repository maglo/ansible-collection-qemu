---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    # ── Base packages ─────────────────────────────────────────
    - name: Check QEMU/KVM packages are installed
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: present
      check_mode: true
      register: pkg_check
      failed_when: pkg_check.changed
      loop:
        - qemu-kvm
        - qemu-img
        - libvirt
        - swtpm
        - swtpm-tools

    # ── noVNC package ─────────────────────────────────────────
    - name: Check novnc package is installed
      ansible.builtin.dnf:
        name: novnc
        state: present
      check_mode: true
      register: novnc_pkg_check
      failed_when: novnc_pkg_check.changed

    # ── noVNC binaries and directories ───────────────────────
    - name: Stat novnc_proxy binary
      ansible.builtin.stat:
        path: /usr/bin/novnc_proxy
      register: novnc_proxy

    - name: Assert novnc_proxy binary exists and is executable
      ansible.builtin.assert:
        that:
          - novnc_proxy.stat.exists
          - novnc_proxy.stat.executable

    - name: Stat noVNC web files directory
      ansible.builtin.stat:
        path: /usr/share/novnc
      register: novnc_webdir

    - name: Assert noVNC web files directory exists
      ansible.builtin.assert:
        that:
          - novnc_webdir.stat.exists
          - novnc_webdir.stat.isdir

    # ── Directories ───────────────────────────────────────────
    - name: Stat VM config directory
      ansible.builtin.stat:
        path: /etc/qemu/vms
      register: vm_config_dir

    - name: Assert VM config directory
      ansible.builtin.assert:
        that:
          - vm_config_dir.stat.exists
          - vm_config_dir.stat.isdir
          - vm_config_dir.stat.pw_name == 'qemu'
          - vm_config_dir.stat.gr_name == 'qemu'
          - vm_config_dir.stat.mode == '0755'

    - name: Stat VM image directory
      ansible.builtin.stat:
        path: /var/lib/qemu/images
      register: vm_image_dir

    - name: Assert VM image directory
      ansible.builtin.assert:
        that:
          - vm_image_dir.stat.exists
          - vm_image_dir.stat.isdir
          - vm_image_dir.stat.pw_name == 'qemu'
          - vm_image_dir.stat.gr_name == 'qemu'
          - vm_image_dir.stat.mode == '0755'

    # ── qemu-vm@ systemd unit ────────────────────────────────
    - name: Stat qemu-vm@ service unit
      ansible.builtin.stat:
        path: /etc/systemd/system/qemu-vm@.service
      register: qemu_vm_unit

    - name: Assert qemu-vm@ service unit file
      ansible.builtin.assert:
        that:
          - qemu_vm_unit.stat.exists
          - qemu_vm_unit.stat.pw_name == 'root'
          - qemu_vm_unit.stat.gr_name == 'root'
          - qemu_vm_unit.stat.mode == '0644'

    # ── Legacy novnc.service removed ─────────────────────────
    - name: Stat legacy novnc.service unit
      ansible.builtin.stat:
        path: /etc/systemd/system/novnc.service
      register: legacy_novnc_unit

    - name: Assert legacy novnc.service is absent
      ansible.builtin.assert:
        that:
          - not legacy_novnc_unit.stat.exists

    # ── noVNC template unit removed ──────────────────────────
    # Per-VM noVNC configuration is now managed by create_vm role
    - name: Stat novnc@.service template unit
      ansible.builtin.stat:
        path: /etc/systemd/system/novnc@.service
      register: novnc_template_unit

    - name: Assert novnc@.service template is absent
      ansible.builtin.assert:
        that:
          - not novnc_template_unit.stat.exists
        fail_msg: "novnc@.service should not be present - per-VM noVNC is now managed by create_vm role"
